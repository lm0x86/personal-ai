{"openapi":"3.1.0","info":{"title":"Product Search API","description":"Multi-vector hybrid search using Milvus: OpenAI dense + BGE-M3 dense + BGE-M3 sparse + CLIP image search","version":"2.1.0"},"servers":[{"url":"/api/products"}],"paths":{"/product":{"post":{"tags":["Products"],"summary":"Add or update product(s)","description":"Add one or more products to the Milvus vector store with hybrid search capabilities.\n\nAccepts either a single product or a list of products.\n\n**Schema Fields:**\n- **index**: Collection name in Milvus (will be created if doesn't exist)\n- **id**: Unique product identifier\n- **title**: Product title (HTML tags will be automatically stripped)\n- **description**: Product description (HTML tags will be automatically stripped)\n- **images**: Optional list of base64 encoded images OR image URLs (used for image search)\n  - Accepts: [\"base64_string\", \"https://example.com/image.jpg\", ...]\n  - Images are automatically downloaded from URLs and resized to max 1024px\n\n**Dynamic Metadata Fields:**\nAny additional fields you include (e.g., price, category, brand, sku, stock, etc.) will be\nautomatically detected and stored as metadata. These fields will be returned flattened in\nsearch results.\n\n**Example:**\n```json\n{\n  \"index\": \"products\",\n  \"id\": \"prod_001\",\n  \"title\": \"Wireless Headphones\",\n  \"description\": \"High-quality headphones\",\n  \"price\": 99.99,\n  \"category\": \"Electronics\",\n  \"brand\": \"TechBrand\"\n}\n```\n\n**Note:** HTML tags in title and description are automatically removed and converted to plain text.\n\nThis endpoint performs an upsert operation - if the product exists, it will be updated.","operationId":"add_product_product_post","security":[{"HTTPBearer":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"anyOf":[{"$ref":"#/components/schemas/ProductCreate"},{"type":"array","items":{"$ref":"#/components/schemas/ProductCreate"}}],"title":"Product"}}}},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}},"get":{"tags":["Products"],"summary":"Get product(s) by ID","description":"Retrieve one or more products by their IDs from the Milvus vector store.\n\n- **index**: Collection name in Milvus\n- **id**: Single product ID or comma-separated list of product IDs\n\nReturns products with all metadata fields flattened into the root object,\nincluding associated images if available.\n\n**Examples:**\n- Single product: `GET /product?index=products&id=prod_001`\n- Multiple products: `GET /product?index=products&id=prod_001,prod_002,prod_003`","operationId":"get_product_product_get","parameters":[{"name":"index","in":"query","required":true,"schema":{"type":"string","title":"Index"}},{"name":"id","in":"query","required":true,"schema":{"type":"string","title":"Id"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}},"delete":{"tags":["Products"],"summary":"Delete product(s)","description":"Delete one or more products from the Milvus vector store.\n\n- **index**: Collection name in Milvus\n- **ids**: List of product IDs to delete","operationId":"delete_product_product_delete","security":[{"HTTPBearer":[]}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/ProductDelete"}}}},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/search":{"post":{"tags":["Search"],"summary":"Search for products (POST)","description":"Search for products using different search algorithms, image search, or text-to-image search.\nOptionally filter results using Milvus query expressions.\n\nThis is the POST version of the search endpoint, accepting a JSON body instead of query parameters.\n\n- **index**: Collection name in Milvus\n- **query**: Free text query for text search (optional)\n- **image**: Base64 encoded image OR image URL for image-to-image similarity search (optional)\n- **image_query**: Text description for text-to-image search (optional) - e.g., \"red sports car\"\n- **filters**: Filter expression (optional) - use simple field names, they're auto-translated to metadata syntax\n- **limit**: Number of results to return (default: 10)\n- **type**: Search algorithm type (default: \"hybrid\")\n\nAt least one of `query`, `image`, or `image_query` must be provided.\n\n**Search Types (for text queries):**\n- `hybrid` (default) → Multi-vector hybrid search with RRF reranker: OpenAI dense + BGE-M3 dense + BGE-M3 sparse\n- `openai_dense` → OpenAI dense embedding search only (fastest, good semantic understanding)\n- `bge_m3_dense` → BGE-M3 dense embedding search only (good for general similarity)\n- `bge_m3_sparse` → BGE-M3 sparse embedding search only (good for keyword/BM25-like matching)\n\n**Image Search:**\n- `image` → Image-to-image search using CLIP image embeddings\n  - Accepts base64 encoded image OR URL (e.g., https://example.com/image.jpg)\n  - Images are automatically resized to max 1024px (keeping aspect ratio)\n- `image_query` → Text-to-image search using CLIP text embeddings\n  - Describe what you want to see in the images (e.g., \"red sports car\", \"modern kitchen\")\n  - Searches product images using natural language descriptions\n\n**Filtering:**\n- Use `filters` to filter results by metadata fields\n- Filters are applied AFTER similarity search for best performance\n- Supports complex boolean expressions (AND, OR, NOT)","operationId":"search_product_post_search_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/ProductSearch"}}},"required":true},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}},"security":[{"HTTPBearer":[]}]}},"/index/{index_name}":{"delete":{"tags":["Admin"],"summary":"Drop/Delete an entire index","description":"Drop/Delete an entire Milvus collection (index) and its associated image collection.\n\n**WARNING**: This permanently deletes all data in the index!\n\n- **index_name**: Name of the collection to drop\n\n**Use Cases:**\n- Testing: Clean up test indexes\n- Reset: Start fresh with a clean index\n- Cleanup: Remove unused indexes","operationId":"drop_index_index__index_name__delete","security":[{"HTTPBearer":[]}],"parameters":[{"name":"index_name","in":"path","required":true,"schema":{"type":"string","title":"Index Name"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/stats/{index_name}":{"get":{"tags":["Admin"],"summary":"Get index statistics","description":"Get statistics about a Milvus collection (index).\n\nReturns:\n- **total_products**: Total number of unique products in the index\n- **total_images**: Total number of images associated with products\n- **index_name**: Name of the collection\n- **has_data**: Whether the index contains any data\n\n**Use Cases:**\n- Monitoring: Check index size and health\n- Testing: Verify data integrity and count\n- Debugging: Inspect collection state","operationId":"get_index_stats_stats__index_name__get","security":[{"HTTPBearer":[]}],"parameters":[{"name":"index_name","in":"path","required":true,"schema":{"type":"string","title":"Index Name"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}},"/sync":{"post":{"tags":["Sync"],"summary":"Start background synchronization job","description":"Start a background job to synchronize products from an external API to Milvus.\n\nReturns immediately with job information. Use the `/job_status` endpoint to check progress.\n\n- **index**: Collection name in Milvus\n- **url**: Base URL to fetch products from (pagination params added automatically)\n- **batch_size**: Number of products to process per batch (default: 100)\n\n**Pagination:**\nThe endpoint automatically appends `limit` and `offset` query parameters:\n- `https://api.example.com/products` → `https://api.example.com/products?limit=100&offset=0`\n- If URL has existing params: `https://api.example.com/products?key=val` → `https://api.example.com/products?key=val&limit=100&offset=0`\n\n**Job Management:**\n- Only one sync job per index can run at a time\n- Job status is tracked in Redis with automatic expiration\n- Lock is automatically refreshed every 15 seconds\n- Job status is updated every 10 seconds with progress\n\n**Sync Process:**\n1. Fetches products from external API with automatic pagination\n2. Strips HTML tags from title and description (converts to plain text)\n3. Processes images (downloads from URLs if needed, resizes to max 1024px)\n4. Detects changes using content hashing (unless force=True)\n5. Only re-embeds new or updated products (unless force=True)\n6. Deletes products that no longer exist in source\n\n**Force Mode (force=True):**\n- Ignores existing product data and change detection\n- Re-processes and re-embeds ALL products from source\n- Useful for:\n  - Migrating to new embedding models\n  - Fixing corrupted data\n  - Complete index rebuild\n- Warning: Much slower than incremental sync\n\n**Note:** \n- HTML tags in title and description are automatically removed and converted to plain text.\n- Images can be base64 encoded strings OR URLs (e.g., \"https://example.com/image.jpg\")\n- All images are automatically resized to max 1024px keeping aspect ratio","operationId":"sync_products_sync_post","requestBody":{"content":{"application/json":{"schema":{"$ref":"#/components/schemas/SyncRequest"}}},"required":true},"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}},"security":[{"HTTPBearer":[]}]}},"/job_status":{"get":{"tags":["Sync"],"summary":"Get sync job status","description":"Get the status of a sync job by job ID or index name.\n\nProvide either `job_id` OR `index` (not both):\n- **job_id**: Unique job identifier returned when starting a sync job\n- **index**: Collection name in Milvus (returns currently running job for this index)\n\n**Query by Job ID:**\nReturns complete job status including:\n- Current status (running, completed, failed)\n- Start time, last update time, completion time\n- Statistics (added, updated, skipped, deleted, errors)\n- Error message if job failed\n\n**Query by Index:**\nReturns the currently running job for the specified index.\nUse this to check if a sync is in progress before starting a new one.\n\n**Examples:**\n- `GET /job_status?job_id=1698765432123456789`\n- `GET /job_status?index=products`","operationId":"get_job_status_job_status_get","security":[{"HTTPBearer":[]}],"parameters":[{"name":"job_id","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Job Id"}},{"name":"index","in":"query","required":false,"schema":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Index"}}],"responses":{"200":{"description":"Successful Response","content":{"application/json":{"schema":{}}}},"422":{"description":"Validation Error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HTTPValidationError"}}}}}}}},"components":{"schemas":{"HTTPValidationError":{"properties":{"detail":{"items":{"$ref":"#/components/schemas/ValidationError"},"type":"array","title":"Detail"}},"type":"object","title":"HTTPValidationError"},"ProductCreate":{"properties":{"index":{"type":"string","title":"Index","description":"The index/collection name in Milvus"},"id":{"type":"string","title":"Id","description":"Unique product ID"},"title":{"type":"string","title":"Title","description":"Product title"},"description":{"type":"string","title":"Description","description":"Product description"},"images":{"anyOf":[{"items":{"type":"string"},"type":"array"},{"type":"null"}],"title":"Images","description":"List of base64 encoded product images"}},"additionalProperties":true,"type":"object","required":["index","id","title","description"],"title":"ProductCreate","example":{"brand":"TechBrand","category":"Electronics","description":"High-quality wireless headphones with noise cancellation","id":"prod_001","images":["base64_encoded_image_string"],"index":"products","price":99.99,"sku":"WH-001","title":"Wireless Headphones"}},"ProductDelete":{"properties":{"index":{"type":"string","title":"Index","description":"The index/collection name in Milvus"},"ids":{"anyOf":[{"items":{"type":"string"},"type":"array"},{"type":"null"}],"title":"Ids","description":"List of product IDs to delete"}},"type":"object","required":["index"],"title":"ProductDelete","example":{"ids":["prod_001","prod_002"],"index":"products"}},"ProductSearch":{"properties":{"index":{"type":"string","title":"Index","description":"The index/collection name in Milvus"},"query":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Query","description":"Free text query for hybrid search"},"context":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Context","description":"Conversation context"},"language":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Language","description":"Conversation language"},"image":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Image","description":"Base64 encoded image for image search"},"image_query":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Image Query","description":"Text description for text-to-image search"},"filters":{"anyOf":[{"additionalProperties":true,"type":"object"},{"type":"string"},{"type":"null"}],"title":"Filters","description":"Additional filters"},"limit":{"type":"integer","title":"Limit","description":"Number of results to return","default":10},"type":{"type":"string","title":"Type","description":"Search algorithm: 'hybrid' (reranker), 'bge_m3_sparse', 'bge_m3_dense', or 'openai_dense'","default":"hybrid"}},"type":"object","required":["index"],"title":"ProductSearch","example":{"index":"products","limit":10,"query":"wireless headphones with noise cancellation"}},"SyncRequest":{"properties":{"index":{"type":"string","title":"Index","description":"The index/collection name in Milvus"},"url":{"type":"string","title":"Url","description":"Base URL to fetch products from (pagination params added automatically)"},"batch_size":{"type":"integer","title":"Batch Size","description":"Number of products to process per batch","default":100},"callback":{"anyOf":[{"type":"string"},{"type":"null"}],"title":"Callback","description":"Optional callback URL to receive status updates (POST endpoint accepting JSON)"},"force":{"type":"boolean","title":"Force","description":"Force full re-sync: ignore existing data and re-process all products (default: False)","default":false}},"type":"object","required":["index","url"],"title":"SyncRequest","example":{"batch_size":100,"callback":"https://example.com/webhook/sync-status","index":"products","url":"https://n8n-7f5783daa123.fineguide.ai/webhook/sync/products"}},"ValidationError":{"properties":{"loc":{"items":{"anyOf":[{"type":"string"},{"type":"integer"}]},"type":"array","title":"Location"},"msg":{"type":"string","title":"Message"},"type":{"type":"string","title":"Error Type"}},"type":"object","required":["loc","msg","type"],"title":"ValidationError"}},"securitySchemes":{"HTTPBearer":{"type":"http","scheme":"bearer"}}}}